<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitOracle - BTC Prediction Markets</title>
    <script src="https://unpkg.com/@stacks/connect@7.7.1/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@stacks/transactions@6.11.0/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@stacks/common@6.8.0/dist/index.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .wallet-section {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .market-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .market-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .market-item h4 {
            color: #333;
            margin-bottom: 8px;
        }

        .market-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        .bet-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .bet-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .bet-yes {
            background: #28a745;
            color: white;
        }

        .bet-no {
            background: #dc3545;
            color: white;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-resolved {
            background: #cce5ff;
            color: #004085;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            display: none;
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">BitOracle</div>
            <div class="wallet-section">
                <span id="wallet-address">Not Connected</span>
                <button id="connect-wallet" class="btn btn-primary">Connect Wallet</button>
            </div>
        </div>

        <div id="notification" class="notification"></div>

        <div class="dashboard-grid">
            <!-- Create Market Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Create Prediction Market</h3>
                </div>
                <form id="create-market-form">
                    <div class="form-group">
                        <label for="question">Question</label>
                        <input type="text" id="question" placeholder="Will BTC reach $100k by end of 2024?" required>
                    </div>
                    <div class="form-group">
                        <label for="target-price">Target Price (in sats)</label>
                        <input type="number" id="target-price" placeholder="100000000000" min="1000000" required>
                    </div>
                    <div class="form-group">
                        <label for="expiry-blocks">Expiry (blocks from now)</label>
                        <input type="number" id="expiry-blocks" placeholder="1440" min="100" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create Market</button>
                </form>
            </div>

            <!-- Active Markets Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Active Markets</h3>
                    <button id="refresh-markets" class="btn btn-secondary">Refresh</button>
                </div>
                <div id="markets-list" class="market-list">
                    <!-- Markets will be loaded here -->
                </div>
            </div>

            <!-- Platform Statistics Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Platform Statistics</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-markets">0</div>
                        <div class="stat-label">Total Markets</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="active-markets">0</div>
                        <div class="stat-label">Active Markets</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-volume">0</div>
                        <div class="stat-label">Total Volume (STX)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="contract-status">Active</div>
                        <div class="stat-label">Contract Status</div>
                    </div>
                </div>
            </div>

            <!-- My Positions Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">My Positions</h3>
                    <button id="refresh-positions" class="btn btn-secondary">Refresh</button>
                </div>
                <div id="positions-list" class="market-list">
                    <!-- User positions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = "ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM";
        const CONTRACT_NAME = "BitOraclecontract";

        // Global state
        let userAddress = null;
        let markets = [];
        let userPositions = [];

        // DOM elements
        const connectWalletBtn = document.getElementById('connect-wallet');
        const walletAddressSpan = document.getElementById('wallet-address');
        const createMarketForm = document.getElementById('create-market-form');
        const marketsList = document.getElementById('markets-list');
        const positionsList = document.getElementById('positions-list');
        const notification = document.getElementById('notification');

        // Stacks Connect configuration
        const appDetails = {
            name: "BitOracle",
            icon: window.location.origin + '/favicon.ico',
        };

        // Connect wallet
        connectWalletBtn.addEventListener('click', async () => {
            if (typeof window.StacksProvider === 'undefined') {
                showNotification('Stacks Wallet not found. Please install the Stacks Wallet extension.', 'error');
                return;
            }

            try {
                const provider = window.StacksProvider();
                const addresses = await provider.getAddresses();
                userAddress = addresses[0].address;
                walletAddressSpan.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                connectWalletBtn.textContent = 'Connected';
                connectWalletBtn.disabled = true;

                showNotification('Wallet connected successfully!', 'success');
                loadMarkets();
                loadUserPositions();
            } catch (error) {
                console.error('Failed to connect wallet:', error);
                showNotification('Failed to connect wallet.', 'error');
            }
        });

        // Create market
        createMarketForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!userAddress) {
                showNotification('Please connect your wallet first.', 'error');
                return;
            }

            const question = document.getElementById('question').value;
            const targetPrice = parseInt(document.getElementById('target-price').value);
            const expiryBlocks = parseInt(document.getElementById('expiry-blocks').value);

            try {
                const functionArgs = [
                    Cl.stringAscii(question),
                    Cl.uint(targetPrice),
                    Cl.uint(expiryBlocks)
                ];

                const result = await callContract('create-market', functionArgs);
                if (result.success) {
                    showNotification('Market created successfully!', 'success');
                    createMarketForm.reset();
                    loadMarkets();
                } else {
                    showNotification(`Failed to create market: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Create market error:', error);
                showNotification('Failed to create market.', 'error');
            }
        });

        // Load markets
        async function loadMarkets() {
            try {
                const marketCounter = await callReadOnly('get-market-counter');
                if (!marketCounter.success) return;

                const totalMarkets = marketCounter.result.value;
                markets = [];

                for (let i = 1; i <= totalMarkets; i++) {
                    const market = await callReadOnly('get-market', [Cl.uint(i)]);
                    if (market.success) {
                        markets.push({ id: i, ...market.result.value });
                    }
                }

                renderMarkets();
                updateStats();
            } catch (error) {
                console.error('Load markets error:', error);
            }
        }

        // Load user positions
        async function loadUserPositions() {
            if (!userAddress) return;

            try {
                userPositions = [];

                for (const market of markets) {
                    const position = await callReadOnly('get-user-position', [
                        Cl.uint(market.id),
                        Cl.principal(userAddress)
                    ]);

                    if (position.success && position.result.value) {
                        const pos = position.result.value;
                        if (pos.yesAmount > 0 || pos.noAmount > 0) {
                            userPositions.push({
                                marketId: market.id,
                                ...pos
                            });
                        }
                    }
                }

                renderUserPositions();
            } catch (error) {
                console.error('Load positions error:', error);
            }
        }

        // Render markets
        function renderMarkets() {
            marketsList.innerHTML = '';

            if (markets.length === 0) {
                marketsList.innerHTML = '<p>No markets found.</p>';
                return;
            }

            markets.forEach(market => {
                const marketElement = document.createElement('div');
                marketElement.className = 'market-item';

                const status = getMarketStatus(market);
                const statusClass = status === 'Active' ? 'status-active' :
                                  status === 'Resolved' ? 'status-resolved' : 'status-expired';

                marketElement.innerHTML = `
                    <h4>${market.question}</h4>
                    <div class="market-stats">
                        <span>Target: ${market.targetPrice} sats</span>
                        <span class="status-indicator ${statusClass}">${status}</span>
                    </div>
                    <div class="market-stats">
                        <span>YES: ${market.totalYesAmount} STX</span>
                        <span>NO: ${market.totalNoAmount} STX</span>
                    </div>
                    ${status === 'Active' ? `
                        <div class="bet-buttons">
                            <button class="bet-btn bet-yes" onclick="placeBet(${market.id}, true)">Bet YES</button>
                            <button class="bet-btn bet-no" onclick="placeBet(${market.id}, false)">Bet NO</button>
                        </div>
                    ` : ''}
                `;

                marketsList.appendChild(marketElement);
            });
        }

        // Render user positions
        function renderUserPositions() {
            positionsList.innerHTML = '';

            if (userPositions.length === 0) {
                positionsList.innerHTML = '<p>No positions found.</p>';
                return;
            }

            userPositions.forEach(position => {
                const market = markets.find(m => m.id === position.marketId);
                if (!market) return;

                const positionElement = document.createElement('div');
                positionElement.className = 'market-item';

                positionElement.innerHTML = `
                    <h4>${market.question}</h4>
                    <div class="market-stats">
                        <span>YES: ${position.yesAmount} STX</span>
                        <span>NO: ${position.noAmount} STX</span>
                    </div>
                    ${!position.claimed && market.resolved ? `
                        <button class="btn btn-primary" onclick="claimWinnings(${position.marketId})" style="width: 100%; margin-top: 10px;">
                            Claim Winnings
                        </button>
                    ` : ''}
                `;

                positionsList.appendChild(positionElement);
            });
        }

        // Update statistics
        function updateStats() {
            const totalMarkets = markets.length;
            const activeMarkets = markets.filter(m => !m.resolved && Date.now() < m.expiryBlock).length;
            const totalVolume = markets.reduce((sum, m) => sum + m.totalYesAmount + m.totalNoAmount, 0);

            document.getElementById('total-markets').textContent = totalMarkets;
            document.getElementById('active-markets').textContent = activeMarkets;
            document.getElementById('total-volume').textContent = (totalVolume / 1000000).toFixed(2) + 'M';
        }

        // Place bet
        async function placeBet(marketId, betYes) {
            if (!userAddress) {
                showNotification('Please connect your wallet first.', 'error');
                return;
            }

            const amount = prompt('Enter bet amount in microSTX (1 STX = 1000000 microSTX):');
            if (!amount || isNaN(amount)) return;

            try {
                const functionArgs = [
                    Cl.uint(marketId),
                    Cl.bool(betYes),
                    Cl.uint(parseInt(amount))
                ];

                const result = await callContract('place-bet', functionArgs);
                if (result.success) {
                    showNotification('Bet placed successfully!', 'success');
                    loadMarkets();
                    loadUserPositions();
                } else {
                    showNotification(`Failed to place bet: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Place bet error:', error);
                showNotification('Failed to place bet.', 'error');
            }
        }

        // Claim winnings
        async function claimWinnings(marketId) {
            if (!userAddress) {
                showNotification('Please connect your wallet first.', 'error');
                return;
            }

            try {
                const functionArgs = [Cl.uint(marketId)];

                const result = await callContract('claim-winnings', functionArgs);
                if (result.success) {
                    showNotification('Winnings claimed successfully!', 'success');
                    loadUserPositions();
                } else {
                    showNotification(`Failed to claim winnings: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Claim winnings error:', error);
                showNotification('Failed to claim winnings.', 'error');
            }
        }

        // Get market status
        function getMarketStatus(market) {
            if (market.resolved) return 'Resolved';
            if (Date.now() > market.expiryBlock) return 'Expired';
            return 'Active';
        }

        // Contract call helpers
        async function callContract(functionName, functionArgs) {
            try {
                const txOptions = {
                    contractAddress: CONTRACT_ADDRESS,
                    contractName: CONTRACT_NAME,
                    functionName: functionName,
                    functionArgs: functionArgs,
                    appDetails: appDetails,
                    onFinish: (data) => {
                        console.log('Transaction:', data);
                    }
                };

                const result = await window.StacksConnect.openContractCall(txOptions);
                return { success: true, result: result };
            } catch (error) {
                console.error('Contract call error:', error);
                return { success: false, error: error.message };
            }
        }

        async function callReadOnly(functionName, functionArgs = []) {
            try {
                const result = await window.StacksConnect.openContractCall({
                    contractAddress: CONTRACT_ADDRESS,
                    contractName: CONTRACT_NAME,
                    functionName: functionName,
                    functionArgs: functionArgs,
                    readOnly: true
                });
                return { success: true, result: result };
            } catch (error) {
                console.error('Read-only call error:', error);
                return { success: false, error: error.message };
            }
        }

        // Notification system
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Event listeners
        document.getElementById('refresh-markets').addEventListener('click', loadMarkets);
        document.getElementById('refresh-positions').addEventListener('click', loadUserPositions);

        // Global functions for onclick handlers
        window.placeBet = placeBet;
        window.claimWinnings = claimWinnings;

        // Initialize
        loadMarkets();
    </script>
</body>
</html>
